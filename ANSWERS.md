# Локальное хранение ответов в tg-relay

## Обзор

Теперь tg-relay сервер может сохранять ответы с устройств локально, не отправляя их в Telegram. Это позволяет:

- Снизить нагрузку на Telegram API
- Сохранить конфиденциальность ответов
- Ускорить обработку
- Собрать статистику

## Конфигурация

### Переменная окружения

В `docker-compose.yml` добавлена переменная:

```yaml
environment:
  - SEND_ANSWERS_TO_TG=false  # true - отправлять в Telegram, false - только локально
```

### Поведение

- **`SEND_ANSWERS_TO_TG=false`** (по умолчанию):
  - Ответы сохраняются только локально
  - В Telegram не отправляются
  - Доступны через API и веб-интерфейс

- **`SEND_ANSWERS_TO_TG=true`**:
  - Ответы сохраняются локально
  - Дублируются в Telegram
  - Полная совместимость со старой системой

## API Endpoints

### Получение истории ответов

```bash
# Все ответы
GET /answers

# Ответы конкретного устройства
GET /answers?device_id=QCTQ_2502

# Ограничение количества
GET /answers?limit=10

# Комбинированный запрос
GET /answers?device_id=QCTQ_2502&limit=5
```

**Ответ:**
```json
{
  "ok": true,
  "answers": [
    {
      "device_id": "QCTQ_2502",
      "message": "DEVICE:QCTQ_2502|ANSWER:ВЕРЮ|RESULT:ПРАВИЛЬНО|Q:Test question",
      "timestamp": "2025-08-26T14:51:03.765Z",
      "type": "quiz_answer"
    }
  ],
  "total": 1,
  "filtered": 1
}
```

### Обновленная статистика

```bash
GET /stats
```

**Ответ:**
```json
{
  "received": 1,
  "sent": 0,
  "bots": 0,
  "answers": 1
}
```

## Веб-интерфейс

В админ-панели (`/admin`) добавлена секция "Answers History":

- Показывает последние 20 ответов
- Отображает устройство, время и ответ
- Автоматическое обновление статистики

## Формат ответов

Устройства отправляют ответы в формате:

```
DEVICE:QCTQ_2502|ANSWER:ВЕРЮ|RESULT:ПРАВИЛЬНО|Q:Test question
```

Где:
- `DEVICE` - ID устройства
- `ANSWER` - ответ пользователя (ВЕРЮ/НЕ ВЕРЮ)
- `RESULT` - результат (ПРАВИЛЬНО/НЕПРАВИЛЬНО)
- `Q` - текст вопроса

## Ограничения

- История ответов ограничена 100 записями
- В веб-интерфейсе показываются последние 20 ответов
- Ответы хранятся в памяти (не в базе данных)

## Мониторинг

### Логи

```bash
sudo docker-compose logs -f relay
```

Ответы логируются:
```
Answer saved from QCTQ_2502: DEVICE:QCTQ_2502|ANSWER:ВЕРЮ|RESULT:ПРАВИЛЬНО|Q:Test question
```

### Статистика

- Количество полученных ответов
- Количество отправленных в Telegram
- Количество активных ботов

## Миграция

### Включение отправки в Telegram

Если нужно вернуть отправку ответов в Telegram:

1. Измените в `docker-compose.yml`:
   ```yaml
   - SEND_ANSWERS_TO_TG=true
   ```

2. Перезапустите контейнер:
   ```bash
   sudo docker-compose restart
   ```

### Экспорт данных

Для экспорта истории ответов:

```bash
curl http://your-vps-ip/answers > answers.json
```

## Преимущества

1. **Производительность** - быстрая обработка ответов
2. **Приватность** - ответы не попадают в Telegram
3. **Аналитика** - удобный сбор статистики
4. **Гибкость** - можно включить/выключить отправку в Telegram
5. **Масштабируемость** - не зависит от лимитов Telegram API
